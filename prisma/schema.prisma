// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH & USER MANAGEMENT ====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(INSPECTOR)
  
  // Organization & Location
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  department     String?
  location       String?
  
  // Settings
  language       String    @default("en")
  timezone       String    @default("UTC")
  
  // Relations
  accounts       Account[]
  sessions       Session[]
  createdChecksheets Checksheet[] @relation("ChecksheetCreator")
  assignedChecksheets ChecksheetAssignment[]
  checksheetResults ChecksheetResult[]
  notifications  Notification[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([organizationId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  description String?
  industry    String?
  country     String?
  timezone    String   @default("UTC")
  
  users       User[]
  checksheets Checksheet[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum UserRole {
  ADMIN
  SUPERVISOR
  INSPECTOR
  VIEWER
}

// ==================== CHECKSHEET MANAGEMENT ====================

model Checksheet {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String?  // manufacturing, construction, healthcare, IT, safety, etc.
  industry    String?
  
  // Template & AI
  isTemplate  Boolean  @default(false)
  isAIGenerated Boolean @default(false)
  aiPrompt    String?  // Original AI prompt if generated
  
  // Status
  status      ChecksheetStatus @default(DRAFT)
  version     Int      @default(1)
  
  // Creator & Organization
  creatorId   String
  creator     User     @relation("ChecksheetCreator", fields: [creatorId], references: [id])
  organizationId String?
  organization Organization? @relation(fields: [organizationId], references: [id])
  
  // Relations
  checkpoints Checkpoint[]
  assignments ChecksheetAssignment[]
  results     ChecksheetResult[]
  
  // Metadata
  tags        String[]
  language    String   @default("en")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([creatorId])
  @@index([organizationId])
  @@index([category])
  @@index([status])
}

model Checkpoint {
  id          String   @id @default(cuid())
  checksheetId String
  checksheet  Checksheet @relation(fields: [checksheetId], references: [id], onDelete: Cascade)
  
  // Checkpoint Details
  title       String
  description String?
  order       Int      // For sorting
  
  // Field Type & Configuration
  fieldType   FieldType
  config      Json?    // Configuration for field (options, min/max, etc.)
  
  // Validation
  isRequired  Boolean  @default(false)
  
  // Grouping
  section     String?  // Group checkpoints into sections
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  responses   CheckpointResponse[]
  
  @@index([checksheetId])
  @@index([order])
}

enum FieldType {
  CHECKBOX       // Simple yes/no checkbox
  NUMBER         // Numeric input with optional min/max
  TEXT           // Text input
  TEXTAREA       // Long text
  PHOTO          // Photo upload
  FILE           // File upload
  DROPDOWN       // Single select dropdown
  MULTISELECT    // Multiple select
  GPS            // GPS coordinates
  SIGNATURE      // Digital signature
  DATE           // Date picker
  TIME           // Time picker
  DATETIME       // Date and time
  RATING         // Star rating
}

enum ChecksheetStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// ==================== CHECKSHEET ASSIGNMENT & EXECUTION ====================

model ChecksheetAssignment {
  id          String   @id @default(cuid())
  checksheetId String
  checksheet  Checksheet @relation(fields: [checksheetId], references: [id], onDelete: Cascade)
  
  assigneeId  String
  assignee    User     @relation(fields: [assigneeId], references: [id])
  
  // Schedule
  dueDate     DateTime?
  frequency   Frequency?  // For recurring checksheets
  
  // Status
  status      AssignmentStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([checksheetId])
  @@index([assigneeId])
  @@index([status])
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model ChecksheetResult {
  id          String   @id @default(cuid())
  checksheetId String
  checksheet  Checksheet @relation(fields: [checksheetId], references: [id])
  
  // Inspector
  inspectorId String
  inspector   User     @relation(fields: [inspectorId], references: [id])
  
  // Result Info
  status      ResultStatus @default(IN_PROGRESS)
  overallScore Float?   // Percentage or score
  
  // Location & Time
  location    String?
  gpsLat      Float?
  gpsLng      Float?
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  // Relations
  responses   CheckpointResponse[]
  
  // Metadata
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([checksheetId])
  @@index([inspectorId])
  @@index([status])
}

enum ResultStatus {
  IN_PROGRESS
  COMPLETED
  APPROVED
  REJECTED
}

model CheckpointResponse {
  id          String   @id @default(cuid())
  checkpointId String
  checkpoint  Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
  
  resultId    String
  result      ChecksheetResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  
  // Response Data (stored as JSON for flexibility)
  value       Json?
  
  // For specific types
  textValue   String?
  numberValue Float?
  boolValue   Boolean?
  dateValue   DateTime?
  
  // Files & Photos
  photoUrls   String[]  // Cloudinary URLs
  fileUrls    String[]
  
  // GPS
  gpsLat      Float?
  gpsLng      Float?
  
  // Status
  status      ResponseStatus @default(OK)
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([checkpointId])
  @@index([resultId])
}

enum ResponseStatus {
  OK
  NOT_OK
  NA           // Not Applicable
  PENDING
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  link      String?
  
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  ASSIGNMENT
  REMINDER
  APPROVAL
  REJECTION
  SYSTEM
}

// ==================== BEST PRACTICE LIBRARY ====================

model BestPracticeTemplate {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String   // manufacturing, construction, healthcare, IT, safety, etc.
  industry    String?
  
  // Template Data (JSON structure of checksheet)
  templateData Json
  
  // Metadata
  tags        String[]
  language    String   @default("en")
  usageCount  Int      @default(0)
  
  isPublic    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([industry])
}

